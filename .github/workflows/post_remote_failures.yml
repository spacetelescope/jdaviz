name: Post Remote Failures Comment

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  actions: read

jobs:
  post-comment:
    runs-on: ubuntu-latest
    name: Post Remote Failures Comment
    steps:
    - name: Download remote failures artifacts from CI workflow
      id: download-artifacts
      uses: dawidd6/action-download-artifact@v6
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        workflow: ci_workflows.yml
        pr: ${{ github.event.pull_request.number }}
        path: remote-failures
        name_is_regexp: true
        name: remote-failures-.*
        if_no_artifact_found: warn

    - name: Check if PR has skip-remote-failures label
      id: check-label
      run: |
        labels="${{ toJSON(github.event.pull_request.labels.*.name) }}"
        if echo "$labels" | grep -q 'skip-remote-failures'; then
          echo "has_label=true" >> $GITHUB_OUTPUT
        else
          echo "has_label=false" >> $GITHUB_OUTPUT
        fi

    - name: Post PR comment with remote failures
      if: steps.check-label.outputs.has_label == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const prNumber = ${{ github.event.pull_request.number }};
          
          try {
            const logPath = 'remote-failures/remote_failures.json';
            if (!fs.existsSync(logPath)) {
              console.log('No remote failures log found at', logPath);
              return;
            }
            
            const failures = JSON.parse(fs.readFileSync(logPath, 'utf8'));
            if (failures.length === 0) {
              console.log('No remote failures recorded');
              return;
            }
            
            let comment = '## Remote Data Test Failures\n\n';
            comment += `${failures.length} test(s) failed due to remote data exceptions:\n\n`;
            
            failures.forEach((failure, index) => {
              comment += `### ${index + 1}. ${failure.test}\n`;
              comment += `- **Exception**: ${failure.exception}\n`;
              comment += `- **Message**: ${failure.message}\n\n`;
            });
            
            comment += '_These tests were skipped due to `--skip-remote-failures` flag._';
            
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
            console.log('Successfully posted PR comment with', failures.length, 'remote failures');
          } catch (error) {
            console.error('Error posting PR comment:', error);
            console.log('This is not a fatal error - the workflow will continue');
          }

