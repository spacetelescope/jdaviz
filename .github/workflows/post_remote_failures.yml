name: Post Remote Failures Comment

on:
  workflow_run:
    workflows: ['CI']
    types: [completed]

permissions:
  pull-requests: write
  actions: read

jobs:
  post-comment:
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion != 'cancelled'
    runs-on: ubuntu-latest
    name: Post Remote Failures Comment
    steps:
    - name: Download remote failures artifacts
      uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.workflow_run.id }}
        path: remote-failures
        pattern: remote-failures-*
        merge-multiple: true

    - name: Get PR number
      id: get-pr
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pullRequests } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.payload.workflow_run.head_sha
          });
          
          if (pullRequests.length === 0) {
            console.log('No PR found for this commit');
            return;
          }
          
          const pr = pullRequests[0];
          core.setOutput('pr_number', pr.number);
          
          // Check if PR has the skip-remote-failures label
          const hasLabel = pr.labels.some(label => label.name === 'skip-remote-failures');
          core.setOutput('has_label', hasLabel);
          
          console.log(`Found PR #${pr.number}, has skip-remote-failures label: ${hasLabel}`);

    - name: Post PR comment with remote failures
      if: steps.get-pr.outputs.has_label == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          const prNumber = '${{ steps.get-pr.outputs.pr_number }}';
          
          if (!prNumber) {
            console.log('No PR number found, skipping comment');
            return;
          }
          
          try {
            const logPath = 'remote-failures/remote_failures.json';
            if (!fs.existsSync(logPath)) {
              console.log('No remote failures log found at', logPath);
              return;
            }
            
            const failures = JSON.parse(fs.readFileSync(logPath, 'utf8'));
            if (failures.length === 0) {
              console.log('No remote failures recorded');
              return;
            }
            
            let comment = '## Remote Data Test Failures\n\n';
            comment += `${failures.length} test(s) failed due to remote data exceptions:\n\n`;
            
            failures.forEach((failure, index) => {
              comment += `### ${index + 1}. ${failure.test}\n`;
              comment += `- **Exception**: ${failure.exception}\n`;
              comment += `- **Message**: ${failure.message}\n\n`;
            });
            
            comment += '_These tests were skipped due to `--skip-remote-failures` flag._';
            
            await github.rest.issues.createComment({
              issue_number: parseInt(prNumber),
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
            console.log('Successfully posted PR comment with', failures.length, 'remote failures');
          } catch (error) {
            console.error('Error posting PR comment:', error);
            console.log('This is not a fatal error - the workflow will continue');
          }

