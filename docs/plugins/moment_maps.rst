.. _plugins-moment_maps:

***********
Moment Maps
***********

.. plugin-availability::

Create moment maps from spectral cubes.

Description
===========

The Moment Maps plugin computes moment maps by integrating flux along the spectral
axis raised to various powers. Moment maps characterize spectral line properties
in 2D, including integrated flux, velocity, and dispersion.

**Key Features:**

* Calculate moment 0 through moment 4 maps
* Continuum subtraction support
* Velocity or wavelength output units
* Spectral region selection
* Export to FITS format

**Available in:** Cubeviz

Details
=======

Moment Orders
-------------

Mathematically, moment N is: $M_N = \int I(\lambda) \lambda^N d\lambda$

* **Moment 0**: Integrated flux (line strength)
* **Moment 1**: Flux-weighted centroid (line center, velocity)
* **Moment 2**: Dispersion (line width, velocity dispersion)
* **Moment 3**: Skewness (asymmetry)
* **Moment 4**: Kurtosis (peak sharpness)

Moment 0 is most commonly used for creating line maps. Moments 1 and 2 are used
for kinematic analysis. Moments 3 and 4 are less common but useful for detailed
line profile analysis.

Output Units
------------

For moment 0, output is in flux * spectral_unit (e.g., Jy * μm).

For moments ≥ 1, choose output units:

* **Wavelength/Spectral Unit**: Output in spectral axis units (μm, Angstrom, Hz, etc.)
* **Velocity**: Output in velocity units (km/s) relative to reference wavelength

Velocity conversion requires specifying a reference wavelength (typically the
rest wavelength of the spectral line of interest).

Continuum Subtraction
---------------------

For clean moment maps of emission or absorption lines, continuum subtraction is
essential. The plugin supports:

* **None**: Use original data (for continuum emission or pre-subtracted data)
* **Fitted**: Use continuum model from Model Fitting plugin
* **Subset-based**: Define continuum regions via spectral subsets

When using continuum subtraction, specify:

* **Continuum dataset**: Which dataset contains the continuum
* **Continuum width**: For subset-based, fractional width of endpoints to use

Spectral Region
---------------

Limit the integration to a specific spectral region:

* **Entire Spectrum**: Use all wavelengths
* **Spectral Subset**: Use defined spectral region (recommended for lines)

For line moment maps, create a spectral subset around the line of interest to
exclude contamination from other features and reduce noise.

UI Access
=========

Opening the Plugin
------------------

**Cubeviz:**
  Click the :guilabel:`Moment Maps` icon in the plugin toolbar.

Workflow
--------

1. **Load cube** into Cubeviz
2. **Select dataset** from :guilabel:`Data` dropdown
3. **Set spectral region**:

   * Draw subset around spectral feature in spectrum viewer, OR
   * Select subset from :guilabel:`Spectral region` dropdown, OR
   * Use :guilabel:`Entire Spectrum`

4. **Configure continuum** (for line maps):

   * Select :guilabel:`Continuum` subtraction method
   * Choose :guilabel:`Continuum dataset` if using fitted continuum
   * Set :guilabel:`Continuum width` if using subset-based

5. **Set moment order** in :guilabel:`Moment` field
6. **Configure output units** (for moment ≥ 1):

   * Select :guilabel:`Output unit` (Spectral Unit or Velocity)
   * If Velocity, set :guilabel:`Reference wavelength`

7. **Set output label** (auto-generated by default)
8. Click :guilabel:`Calculate` to create moment map
9. **(Optional)** Click :guilabel:`Save as FITS` to export

Results
-------

The moment map is:

* Displayed in selected image viewer
* Available in data dropdown menus
* Can be saved to FITS file

API Access
==========

Accessing the Plugin
--------------------

.. code-block:: python

    from jdaviz import Cubeviz

    cubeviz = Cubeviz()
    cubeviz.show()
    cubeviz.load('cube.fits', format='3D Spectrum')

    # Access plugin
    plg = cubeviz.plugins['Moment Maps']

Moment 0 Map (Line Flux)
------------------------

.. code-block:: python

    # Configure for moment 0
    plg.dataset = 'cube[FLUX]'
    plg.spectral_subset = 'Subset 1'  # Around emission line
    plg.n_moment = 0

    # Calculate
    moment_map = plg.calculate_moment(add_data=True)

Moment 1 Map (Velocity)
-----------------------

.. code-block:: python

    # Configure for velocity moment 1
    plg.n_moment = 1
    plg.output_unit = 'Velocity'
    plg.reference_wavelength = 6562.8  # H-alpha in Angstroms

    velocity_map = plg.calculate_moment(add_data=True)

Continuum Subtraction
---------------------

.. code-block:: python

    # Use fitted continuum
    plg.continuum = 'Fitted'
    plg.continuum_dataset = 'fitted_continuum'

    # Or use subset-based continuum
    plg.continuum = 'Subset'
    plg.continuum_width = 0.1  # Use 10% of endpoints

    moment_map = plg.calculate_moment(add_data=True)

Moment 2 Map (Dispersion)
-------------------------

.. code-block:: python

    # Velocity dispersion in km/s
    plg.n_moment = 2
    plg.output_unit = 'Velocity'
    plg.reference_wavelength = 6562.8

    dispersion_map = plg.calculate_moment(add_data=True)

Custom Output
-------------

.. code-block:: python

    # Control output
    plg.add_results.label = 'halpha_moment0'
    plg.add_results.viewer = 'flux-viewer'

    # Calculate without adding to app
    moment_map = plg.calculate_moment(add_data=False)

    # Access data
    flux_array = plg.moment.data
    wcs = plg.moment.wcs

Batch Processing
----------------

.. code-block:: python

    # Calculate multiple moments
    lines = {
        'halpha': {'subset': 'Subset 1', 'ref_wave': 6562.8},
        'nii': {'subset': 'Subset 2', 'ref_wave': 6583.5}
    }

    for line_name, params in lines.items():
        plg.spectral_subset = params['subset']
        plg.reference_wavelength = params['ref_wave']

        for n in [0, 1, 2]:
            plg.n_moment = n
            plg.add_results.label = f'{line_name}_m{n}'
            plg.calculate_moment(add_data=True)

.. plugin-api-refs::
   :module: jdaviz.configs.cubeviz.plugins.moment_maps.moment_maps
   :class: MomentMap

Example Notebooks
=================

* :gh-notebook:`CubevizExample.ipynb <CubevizExample>` - Includes moment map examples

See Also
========

* :ref:`moment-maps` - Detailed Cubeviz moment maps documentation
* :ref:`collapse` - Alternative collapse method
* :ref:`spectral-extraction` - Extract 1D spectra
