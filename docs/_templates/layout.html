{# Custom layout template for pydata-sphinx-theme #}
{# Extends the base layout to allow customization of navbar and header #}
{% extends "!layout.html" %}

{# Custom navbar - show different items based on page metadata #}
{% block header %}
  {% if pagename == 'index' %}
    {# Landing page - hide the standard navbar completely #}
    <style>
      #pst-page-navigation-contents {
        display: none !important;
      }
      .bd-header {
        display: none !important;
      }
      .bd-header__inner {
        display: none !important;
      }
    </style>
  {% elif meta and meta.get('navbar_style') == 'minimal' %}
    {# New pages - show simplified navbar #}
    {{ super() }}
    <style>
      /* Customize navbar for new pages */
      .bd-header {
        background: var(--pst-color-primary);
      }
    </style>
  {% else %}
    {# Deprecated/legacy pages - keep original navbar #}
    {{ super() }}
  {% endif %}
{% endblock %}

{# Optional: Customize the navbar contents #}
{% block navbar_header_items %}
  {% if not (pagename == 'index') %}
    {# Show standard navbar items for all pages except landing page #}
    {{ super() }}
  {% endif %}
{% endblock %}

{# Optional: Add custom navbar links based on platform context #}
{% block navbar_end %}
  {% if pagename != 'index' %}
    {{ super() }}
    {# Platform dropdown in navbar #}
    <style>
      .platform-dropdown {
        position: relative;
        display: inline-block;
      }

      .platform-dropdown-button {
        background-color: rgba(255, 255, 255, 0.1);
        color: var(--pst-color-text-base, #ffffff);
        padding: 6px 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s ease;
      }

      .platform-dropdown-button:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }

      .platform-dropdown-arrow {
        font-size: 10px;
        transition: transform 0.2s ease;
      }

      .platform-dropdown.open .platform-dropdown-arrow {
        transform: rotate(180deg);
      }

      .platform-dropdown-menu {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 4px;
        background-color: var(--pst-color-background, #ffffff);
        border: 1px solid var(--pst-color-border, #cccccc);
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 160px;
        z-index: 1000;
      }

      .platform-dropdown.open .platform-dropdown-menu {
        display: block;
      }

      .platform-dropdown-item {
        padding: 8px 16px;
        cursor: pointer;
        color: var(--pst-color-text-base);
        transition: background-color 0.15s ease;
        white-space: nowrap;
      }

      .platform-dropdown-item:hover {
        background-color: var(--pst-color-secondary, #f0f0f0);
      }

      .platform-dropdown-item.active {
        background-color: var(--pst-color-primary-bg, #e3f2fd);
        font-weight: 600;
      }

      .platform-dropdown-item:first-child {
        border-radius: 4px 4px 0 0;
      }

      .platform-dropdown-item:last-child {
        border-radius: 0 0 4px 4px;
      }
    </style>
    <script>
      // Add platform dropdown to navbar if on new-style page
      document.addEventListener('DOMContentLoaded', function() {
        // Check if this is a new-style page with minimal navbar
        const isNewStylePage = document.querySelector('meta[content="minimal"]');
        if (!isNewStylePage) return;

        const platformOptions = [
          { value: 'desktop', label: 'Desktop', icon: 'üñ•Ô∏è' },
          { value: 'mast', label: 'MAST', icon: 'üî≠' },
          { value: 'jupyter', label: 'Jupyter', icon: 'üìì' },
          { value: 'platform', label: 'Cloud Platform', icon: '‚òÅÔ∏è' }
        ];

        // Get current platform from URL or sessionStorage
        const urlParams = new URLSearchParams(window.location.search);
        const platformFromUrl = urlParams.get('platform');
        const platformFromStorage = sessionStorage.getItem('jdaviz-platform');
        let currentPlatform = platformFromUrl || platformFromStorage || null;

        const navbar = document.querySelector('.navbar-nav');
        if (navbar) {
          // Create dropdown container
          const dropdownContainer = document.createElement('li');
          dropdownContainer.className = 'nav-item platform-dropdown';

          // Create dropdown button
          const currentOption = platformOptions.find(opt => opt.value === currentPlatform);
          const buttonLabel = currentOption ?
            currentOption.icon + ' ' + currentOption.label :
            'üìç Select Platform';

          const dropdownButton = document.createElement('button');
          dropdownButton.className = 'platform-dropdown-button';
          dropdownButton.innerHTML = '<span class="platform-label">' + buttonLabel + '</span>' +
            '<span class="platform-dropdown-arrow">‚ñº</span>';

          // Create dropdown menu
          const dropdownMenu = document.createElement('div');
          dropdownMenu.className = 'platform-dropdown-menu';

          // Add platform options
          platformOptions.forEach(function(option) {
            const item = document.createElement('div');
            item.className = 'platform-dropdown-item';
            if (option.value === currentPlatform) {
              item.classList.add('active');
            }
            item.textContent = option.icon + ' ' + option.label;
            item.setAttribute('data-platform', option.value);

            item.addEventListener('click', function() {
              // Update platform context
              sessionStorage.setItem('jdaviz-platform', option.value);

              // Update body class
              document.body.className = document.body.className.replace(/platform-\w+/g, '');
              document.body.classList.add('platform-' + option.value);
              document.body.setAttribute('data-jdaviz-platform', option.value);

              // Update button label
              const buttonLabelElement = dropdownButton.querySelector('.platform-label');
              buttonLabelElement.textContent = option.icon + ' ' + option.label;

              // Update active state
              dropdownMenu.querySelectorAll('.platform-dropdown-item').forEach(function(el) {
                el.classList.remove('active');
              });
              item.classList.add('active');

              // Close dropdown
              dropdownContainer.classList.remove('open');

              // Optionally reload page to update platform-specific content
              // or use platform-context.js to intercept links
              if (window.jdavizPlatform) {
                window.jdavizPlatform.set(option.value);
              }
            });

            dropdownMenu.appendChild(item);
          });

          // Toggle dropdown on button click
          dropdownButton.addEventListener('click', function(e) {
            e.stopPropagation();
            dropdownContainer.classList.toggle('open');
          });

          // Close dropdown when clicking outside
          document.addEventListener('click', function() {
            dropdownContainer.classList.remove('open');
          });

          // Prevent dropdown from closing when clicking inside menu
          dropdownMenu.addEventListener('click', function(e) {
            e.stopPropagation();
          });

          dropdownContainer.appendChild(dropdownButton);
          dropdownContainer.appendChild(dropdownMenu);
          navbar.appendChild(dropdownContainer);
        }
      });
    </script>
  {% endif %}
{% endblock %}
